(()=>{"use strict";var e="https://nomoreparties.co/v1/".concat("wff-cohort-42"),t={authorization:"40da0db7-490e-4674-9460-ee104bc87e71","Content-Type":"application/json"};function n(e){return e.ok?204===e.status?Promise.resolve({}):e.json():e.json().then((function(t){var n=new Error(t.message||"Ошибка ".concat(e.status));return n.status=e.status,n.body=t,Promise.reject(n)})).catch((function(){var t=new Error("Ошибка ".concat(e.status));return t.status=e.status,Promise.reject(t)}))}var r=document.querySelector("#card-template").content;function o(o,i,c){var a=r.querySelector(".card").cloneNode(!0),u=a.querySelector(".card__image"),l=a.querySelector(".card__title"),s=a.querySelector(".card__delete-button"),d=a.querySelector(".card__like-button"),p=a.querySelector(".card__likes-count");u.src=o.link,u.alt=o.name,l.textContent=o.name;var f=Array.isArray(o.likes)?o.likes:[];p.textContent=String(f.length),c&&f.some((function(e){return!!e&&(e._id&&e._id===c||"string"==typeof e&&e===c)}))?d.classList.add("card__like-button_is-active"):d.classList.remove("card__like-button_is-active"),d.addEventListener("click",(function(){var r=o._id,i=d.classList.contains("card__like-button_is-active");d.disabled=!0;var a=i?function(r){return fetch("".concat(e,"/cards/likes/").concat(r),{method:"DELETE",headers:t}).then(n)}(r):function(r){return fetch("".concat(e,"/cards/likes/").concat(r),{method:"PUT",headers:t}).then(n)}(r);a.then((function(e){var t=Array.isArray(e.likes)?e.likes:[];p.textContent=String(t.length),f.length=0,t.forEach((function(e){return f.push(e)})),t.some((function(e){return e._id&&e._id===c||"string"==typeof e&&e===c}))?d.classList.add("card__like-button_is-active"):d.classList.remove("card__like-button_is-active")})).catch((function(e){console.error("Ошибка при обновлении лайка:",e)})).finally((function(){d.disabled=!1}))}));var m=o.owner?o.owner._id||o.owner:null;return m&&c&&m===c?(s.style.display="",s.addEventListener("click",(function(){var r;s.disabled=!0,(r=o._id,fetch("".concat(e,"/cards/").concat(r),{method:"DELETE",headers:t}).then(n)).then((function(){a.remove()})).catch((function(e){console.error("Ошибка при удалении карточки:",e),alert("Не удалось удалить карточку. Попробуйте ещё раз.")})).finally((function(){s.disabled=!1}))}))):s.style.display="none",u.addEventListener("click",(function(){i(o.link,o.name)})),a}function i(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",a)}function c(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",a)}function a(e){if("Escape"===e.key){var t=document.querySelector(".popup_is-opened");t&&c(t)}}function u(e,t){e.target===t&&c(t)}function l(e){return/^(https?:\/\/)([^\s]+)/.test(e)}function s(e,t){var n,r=(null===(n=e.closest(t.formSelector))||void 0===n?void 0:n.querySelector(".".concat(e.id,"-error")))||document.querySelector("#".concat(e.id,"-error"))||document.querySelector("#".concat(e.name,"-error"));r&&(e.classList.remove(t.inputErrorClass),r.textContent="",r.classList.remove(t.errorClass))}function d(e){return/^[а-яА-ЯЁёa-zA-Z\s-]+$/.test(e)}function p(e,t,n){var r=Array.from(e).every((function(e){return e.validity.valid}));t.disabled=!r,t.classList.toggle(n,!r)}function f(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(e){e.setCustomValidity(""),s(e,t)})),r.classList.add(t.inactiveButtonClass),r.disabled=!0}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var v=null,y=document.querySelector(".places__list");Promise.all([fetch("".concat(e,"/users/me"),{headers:t}).then(n),fetch("".concat(e,"/cards"),{headers:t}).then(n)]).then((function(e){var t,n,r=(n=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,c,a=[],u=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);u=!0);}catch(e){l=!0,o=e}finally{try{if(!u&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(l)throw o}}return a}}(t,n)||function(e,t){if(e){if("string"==typeof e)return m(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(e,t):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=r[0],c=r[1];v=i._id,document.querySelector(".profile__title").textContent=i.name,document.querySelector(".profile__description").textContent=i.about;var a=document.querySelector(".profile__image");"IMG"===a.tagName?a.src=i.avatar:a.style.backgroundImage="url(".concat(i.avatar,")"),c.forEach((function(e){if(e&&e.link&&e.name&&e._id){var t=o(e,z,v);y.appendChild(t)}else console.error("Некорректные данные карточки:",e)}))})).catch((function(e){console.error("Ошибка загрузки данных: ".concat(e))}));var _,S={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};_=S,document.querySelectorAll(_.formSelector).forEach((function(e){return function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(e){e.addEventListener("input",(function(){(function(e,t){var n=e.value.trim(),r=n.length;e.setCustomValidity(""),e.validity.valueMissing&&e.setCustomValidity("Вы пропустили это поле."),"name"!==e.name||e.validity.valueMissing||(r<2||r>40)&&e.setCustomValidity("Минимальное количество символов: 2. Длина текста сейчас: 1 символ."),"description"!==e.name||e.validity.valueMissing||(r<2||r>200?e.setCustomValidity("Минимальное количество символов: 2. Длина текста сейчас: 1 символ."):d(n)||e.setCustomValidity("Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы.")),"place-name"!==e.name||e.validity.valueMissing||(r<2||r>30?e.setCustomValidity("Минимальное количество символов: 2. Длина текста сейчас: 1 символ."):d(n)||e.setCustomValidity("Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы.")),"link"!==e.name||e.validity.valueMissing||l(n)||e.setCustomValidity("Введите адрес сайта."),e.validity.valid?s(e,t):function(e,t,n){var r,o=(null===(r=e.closest(n.formSelector))||void 0===r?void 0:r.querySelector(".".concat(e.id,"-error")))||document.querySelector("#".concat(e.id,"-error"))||document.querySelector("#".concat(e.name,"-error"));o&&(e.classList.add(n.inputErrorClass),o.textContent=t,o.classList.add(n.errorClass))}(e,e.validationMessage,t)})(e,t),p(n,r,t.inactiveButtonClass)})),e.addEventListener("focus",(function(){return s(e,t)})),e.addEventListener("click",(function(){return s(e,t)}))})),p(n,r,t.inactiveButtonClass)}(e,_)}));var h=document.querySelector("#popupEditAvatar"),b=h?h.querySelector('form[name="formEditAvatar"]'):null,q=b?b.querySelector("#avatar-link-input"):null,C=b?b.querySelector(".form__submit"):null,g=b?b.querySelector("#avatar-link-input-error"):null,E=h?h.querySelector(".popup__close"):null;E&&E.addEventListener("click",(function(){return c(h)})),h&&h.addEventListener("click",(function(e){e.target===h&&c(h)}));var k=document.querySelector(".image-button");k&&h&&k.addEventListener("click",(function(){q&&(q.value=""),b&&f(b,S),i(h)})),b&&b.addEventListener("submit",(function(r){r.preventDefault();var o=q.value.trim();if(o&&l(o)){if(C){C.active=!0,C.textContent="Сохранение...";var i=document.querySelector(".profile__image");i&&(i.style.backgroundImage="url('".concat(o,"')")),new Promise((function(e){return setTimeout(e,300)})).then((function(){return r=o,fetch("".concat(e,"/users/me/avatar"),{method:"PATCH",headers:t,body:JSON.stringify({avatar:r})}).then(n);var r})).then((function(e){e&&e.avatar?i.style.backgroundImage="url('".concat(e.avatar,"')"):i.style.backgroundImage="url('".concat(o,"')"),c(h),g&&(g.textContent="")})).catch((function(e){console.error("Ошибка обновления аватара:",e),g&&(g.textContent="string"==typeof e?e:"Ошибка при обновлении аватара")})).finally((function(){C.disabled=!1,C.textContent="Сохранить"}))}}else q.reportValidity()}));var L=document.querySelector('form[name="edit-profile"]'),x=document.querySelector('form[name="new-place"]'),A=document.querySelector(".popup_type_edit"),w=document.querySelector(".popup_type_new-card"),T=document.querySelector(".popup_type_image"),P=T.querySelector(".popup__image"),V=T.querySelector(".popup__caption"),j=document.querySelector(".profile__title"),I=document.querySelector(".profile__description"),M=A.querySelector(".popup__input_type_name"),B=A.querySelector(".popup__input_type_description"),O=w.querySelector(".popup__input_type_card-name"),D=w.querySelector(".popup__input_type_url");function N(){c(A)}function J(){c(w)}function z(e,t){P.src=e,P.alt=t,V.textContent=t,i(T)}document.querySelector(".profile__edit-button").addEventListener("click",(function(){M.value=j.textContent,B.value=I.textContent,f(L,S),i(A)})),A.querySelector(".popup__close").addEventListener("click",N),L.addEventListener("submit",(function(r){r.preventDefault();var o=M.value.trim(),i=B.value.trim();if(o){var c=L.querySelector('button[type="submit"]'),a=c?c.textContent:null;c&&(c.active=!0,c.textContent="Сохранение..."),new Promise((function(e){return setTimeout(e,300)})).then((function(){return function(r,o){return fetch("".concat(e,"/users/me"),{method:"PATCH",headers:t,body:JSON.stringify({name:r,about:o})}).then(n)}(o,i)})).then((function(e){var t,n;e&&(j.textContent=null!==(t=e.name)&&void 0!==t?t:o,I.textContent=null!==(n=e.about)&&void 0!==n?n:i),N()})).catch((function(e){console.error("Ошибка при обновлении профиля:",e),alert("string"==typeof e?e:"Ошибка при сохранении профиля")})).finally((function(){c&&(c.disabled=!1,c.textContent=a||"Сохранить")}))}})),document.querySelector(".profile__add-button").addEventListener("click",(function(){i(w)})),w.querySelector(".popup__close").addEventListener("click",J),w.querySelector(".popup__button").addEventListener("click",(function(r){if(r.preventDefault(),O.value&&D.value){var i=w.querySelector(".popup__button"),c={name:O.value,link:D.value};i&&(i.active=!0,i.textContent="Сохранение...",setTimeout((function(){var r;(r=c,fetch("".concat(e,"/cards"),{method:"POST",headers:t,body:JSON.stringify(r)}).then(n)).then((function(e){var t=o(e,z,v);y.prepend(t),J(),x&&(x.reset(),f(x,S)),i&&(i.disabled=!0,i.textContent="Сохранить")})).catch((function(e){console.error("Ошибка создания карточки:",e),i&&(i.disabled=!1,i.textContent="Сохранить")}))}),300))}})),T.querySelector(".popup__close").addEventListener("click",(function(){c(T)})),A.addEventListener("mousedown",(function(e){return u(e,A)})),w.addEventListener("mousedown",(function(e){return u(e,w)})),T.addEventListener("mousedown",(function(e){return u(e,T)}))})();